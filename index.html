<!DOCTYPE html>
<html land="zh-Hant">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="assets/css/main.css">
    <script type="text/javascript" src="assets/js/StickerUnit.js"></script>
    <script type="text/javascript" src="assets/js/Sticker.js"></script>
</head>
<body>
    <div id="app">
        <main id="frame" class="fullViewport">
            <div id="canvas-wrapper" class="fullHeight">
                <canvas id="canvas"></canvas>
            </div>
        </main>
        <div id="permission-wrapper" class="fullViewport">
            <div id="permission-message">
                <p>This website would like to access the orientation of your device.</p>
                <div class="btns-wrapper">
                <button id="deny-permission-btn" class="btn">Deny</button><button id="accept-permission-btn" class="btn">Accept</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let canvas = document.getElementById("canvas");
        let sticker = new Sticker(canvas);
        sticker.draw(30);
        
        if (window.DeviceOrientationEvent) {
            // let beta_range = [-90, 90];
            // let gamma_range = [-45, 45];
            // beta_range.push(beta_range[1] - beta_range[0]);
            // gamma_range.push(gamma_range[1] - gamma_range[0]);
            let ticking = false;
            function permission () {
                if ( typeof( DeviceOrientationEvent ) == "undefined" || typeof( DeviceOrientationEvent.requestPermission ) !== "function" ){
                    // alert( "DeviceMotionEvent is not defined" );
                    return null;
                }
                console.log("permission");
                // (optional) Do something before API request prompt.
                DeviceOrientationEvent.requestPermission()
                .then( response => {
                    // (optional) Do something after API prompt dismissed.
                    if ( response == "granted" ) {
                        window.addEventListener('deviceorientation', function(event){
                            if(!ticking) {
                                requestAnimationFrame(function(){
                                    //beta: x axis. In degree in the range [-180,180)
                                    //gamma y axis. In degree in the range [-90,90)
                                    let beta = event.beta * Math.PI * 2 / 360;
                                    console.log(beta);
                                    sticker.draw(beta);

                                    ticking = false;
                                });
                            }
                            ticking = true;
                        });
                    }
                })
                .catch( console.error );
            }
            const sAccept_permission_btn = document.getElementById("accept-permission-btn");
            sAccept_permission_btn.addEventListener( "click", permission );
        }
    </script>
</body>
</html>